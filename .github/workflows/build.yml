name: build
run-name: 'build → ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}'

on:
  workflow_run:
    workflows: ['typecheck']
    branches: [main, dev]
    types: [completed]

  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build ${{ matrix.artifact_ext }} (${{ matrix.platform }}) on ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.ref_name }}
    if: ${{ (github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')) && github.actor != 'github-actions' }}
    runs-on: ${{ matrix.os }}
    env:
      BUILD_BRANCH: ${{ github.event.inputs.branch || github.event.workflow_run.head_branch || github.head_ref || github.ref_name }}
    strategy:
      matrix:
        include:
          - platform: x86_64
            os: ubuntu-latest
            arch: native
            artifact_ext: AppImage
          - platform: arm64
            os: ubuntu-latest
            arch: emulated
            artifact_ext: AppImage
          - platform: darwin
            os: macos-latest
            arch: native
            artifact_ext: dmg

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch && format('refs/heads/{0}', github.event.inputs.branch) || format('refs/heads/{0}', github.event.workflow_run.head_branch) }}

      - name: Fetch latest Node.js 22.x
        run: |
          curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.version | test("^v22\\.\\d+\\.\\d+$"))][0].version' > .nvmrc
          echo "Using Node version: $(cat .nvmrc)"

      - name: Setup latest Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Setup npm 11.x
        run: |
          npm i -g npm@^11
          echo "npm version: $(npm -v)"
          node -e "const v=require('child_process').execSync('npm -v').toString().trim(); if(!/^11\./.test(v)){console.error('Expected npm 11.x, got', v); process.exit(1);} console.log('npm 11 OK');"

      - name: Set electron-builder cache path
        run: echo "ELECTRON_BUILDER_CACHE=$RUNNER_TEMP/.cache/electron-builder" >> "$GITHUB_ENV"

      - name: Capture runtime versions
        id: rt
        run: |
          echo "node=$(node -v | sed 's/^v//')" >> "$GITHUB_OUTPUT"
          echo "npm=$(npm -v)" >> "$GITHUB_OUTPUT"

      - name: Read version from package.json
        id: pkg
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Read Electron semver from package.json
        id: el
        run: |
          echo "semver=$(node -p 'require(\"./package.json\").devDependencies.electron')" >> "$GITHUB_OUTPUT"

      - name: Build for x86_64 (native)
        if: matrix.platform == 'x86_64'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
              build-essential python3 python3-dev libusb-1.0-0-dev libudev-dev \
              pkg-config libusb-1.0-0 libudev1 ca-certificates
          sudo rm -rf /var/lib/apt/lists/*

          # Install from package-lock
          npm run install:ci

      # Resolve installed Electron version (for caches & headers)
      - name: Resolve Electron version (installed) [x86_64]
        if: matrix.platform == 'x86_64'
        id: elres_x86
        run: |
          ELECTRON_VERSION="$(node -p "require('./node_modules/electron/package.json').version")"
          echo "resolved=${ELECTRON_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Cache Electron headers (resolved) [x86_64]
        if: matrix.platform == 'x86_64'
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.electron-gyp
            $HOME/.cache/node-gyp
            $HOME/Library/Caches/node-gyp
          key: electron-gyp-${{ runner.os }}-${{ steps.elres_x86.outputs.resolved }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            electron-gyp-${{ runner.os }}-${{ steps.elres_x86.outputs.resolved }}-
            electron-gyp-${{ runner.os }}-

      - name: Cache electron-builder cache (resolved) [x86_64]
        if: matrix.platform == 'x86_64'
        uses: actions/cache@v4
        with:
          path: ${{ env.ELECTRON_BUILDER_CACHE }}
          key: eb-cache-${{ runner.os }}-${{ steps.elres_x86.outputs.resolved }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            eb-cache-${{ runner.os }}-${{ steps.elres_x86.outputs.resolved }}-
            eb-cache-${{ runner.os }}-

      - name: Build for x86_64 (native Ubuntu)
        if: matrix.platform == 'x86_64'
        shell: bash
        run: |
          set -euo pipefail

          # Prefetch headers for the installed Electron version
          ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
          echo "electron=$ELECTRON_VERSION"
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist

          # Rebuild native deps against Electron
          npm run rebuild:native

          npm run typecheck
          rm -rf dist
          npm run build:linux

      - name: Build for ARM64 (emulated)
        if: matrix.platform == 'arm64'
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: none
          distro: none
          base_image: --platform=linux/arm64/v8 node:22-trixie-slim
          run: |
            set -euo pipefail

            # ARM64 check
            echo "uname -m: $(uname -m)"
            echo "dpkg arch: $(dpkg --print-architecture)"
            echo "node arch: $(node -p process.arch)"

            apt-get update
            apt-get install -y --no-install-recommends git build-essential python3 python3-dev libusb-1.0-0-dev libudev-dev pkg-config libusb-1.0-0 libudev1 ca-certificates
            rm -rf /var/lib/apt/lists/*

            npm i -g npm@^11
            echo "npm version: $(npm -v)"
            node -e "const v=require('child_process').execSync('npm -v').toString().trim(); if(!/^11\./.test(v)){console.error('Expected npm 11.x, got', v); process.exit(1);} console.log('npm 11 OK');"

            echo "==> Waiting for file system to settle (QEMU workaround)..."
            sleep 15

            # Install from package-lock
            npm run install:ci

            ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
            echo "electron=$ELECTRON_VERSION"
            npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist

            npm run rebuild:native
            npm run build:armLinux

            mkdir -p /github/workspace/dist/
            cp dist/*-arm64.AppImage /github/workspace/dist/

      - name: Build for macOS (native)
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          brew update >/dev/null
          for pkg in libusb pkg-config; do
            if ! brew list --versions "$pkg" >/dev/null; then
              echo "Installing $pkg..."
              brew install "$pkg" >/dev/null
            elif brew outdated --quiet | grep -q "^$pkg\$"; then
              echo "Upgrading $pkg..."
              brew upgrade "$pkg" >/dev/null
            else
              echo "$pkg is up-to-date."
            fi
          done

          npm i -g npm@^11
          echo "npm version: $(npm -v)"
          node -e "const v=require('child_process').execSync('npm -v').toString().trim(); if(!/^11\./.test(v)){console.error('Expected npm 11.x, got', v); process.exit(1);} console.log('npm 11 OK');"

          # Install from package-lock
          npm run install:ci

      # Resolve installed Electron version (for caches & headers)
      - name: Resolve Electron version (installed) [darwin]
        if: matrix.platform == 'darwin'
        id: elres_mac
        run: |
          ELECTRON_VERSION="$(node -p "require('./node_modules/electron/package.json').version")"
          echo "resolved=${ELECTRON_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Cache Electron headers (resolved) [darwin]
        if: matrix.platform == 'darwin'
        uses: actions/cache@v4
        with:
          path: |
            $HOME/.electron-gyp
            $HOME/.cache/node-gyp
            $HOME/Library/Caches/node-gyp
          key: electron-gyp-${{ runner.os }}-${{ steps.elres_mac.outputs.resolved }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            electron-gyp-${{ runner.os }}-${{ steps.elres_mac.outputs.resolved }}-
            electron-gyp-${{ runner.os }}-

      - name: Cache electron-builder cache (resolved) [darwin]
        if: matrix.platform == 'darwin'
        uses: actions/cache@v4
        with:
          path: ${{ env.ELECTRON_BUILDER_CACHE }}
          key: eb-cache-${{ runner.os }}-${{ steps.elres_mac.outputs.resolved }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            eb-cache-${{ runner.os }}-${{ steps.elres_mac.outputs.resolved }}-
            eb-cache-${{ runner.os }}-

      - name: Build for macOS (native)
        if: matrix.platform == 'darwin'
        shell: bash
        run: |
          set -euo pipefail

          ELECTRON_VERSION=$(node -p "require('./node_modules/electron/package.json').version")
          echo "electron=$ELECTRON_VERSION"
          npx --yes node-gyp install --target="$ELECTRON_VERSION" --dist-url=https://artifacts.electronjs.org/headers/dist

          # Rebuild native deps against Electron
          npm run rebuild:native

          npm run typecheck
          npm run build:mac

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pi-carplay-${{ steps.pkg.outputs.version }}-${{ matrix.platform }}.${{ matrix.artifact_ext }}
          path: |
            dist/*${{ matrix.artifact_ext == 'dmg' && 'arm64.dmg' || (matrix.artifact_ext == 'AppImage' && (matrix.platform == 'arm64' && '-arm64.AppImage' || '-x86_64.AppImage')) }}
          retention-days: 7

      - name: Write version badge JSON
        if: matrix.platform == 'x86_64' && (env.BUILD_BRANCH == 'main' || env.BUILD_BRANCH == 'dev')
        run: |
          BRANCH_NAME="${BUILD_BRANCH}"
          mkdir -p .github/badges
          echo "{\"schemaVersion\":1,\"label\":\"${BRANCH_NAME}\",\"message\":\"v${{ steps.pkg.outputs.version }}\",\"color\":\"lightgrey\"}" > ".github/badges/${BRANCH_NAME}-version.json"

      - name: Push version badge to version branch
        if: matrix.platform == 'x86_64' && (env.BUILD_BRANCH == 'main' || env.BUILD_BRANCH == 'dev')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          BRANCH_NAME="${BUILD_BRANCH}"
          VERSION="${{ steps.pkg.outputs.version }}"
          NODE_VERSION="${{ steps.rt.outputs.node }}"
          NPM_VERSION="${{ steps.rt.outputs.npm }}"
          ELECTRON_SEMVER="$(node -e "try{console.log(require('./node_modules/electron/package.json').version)}catch(e){try{console.log(require('./package.json').devDependencies.electron)}catch(e){console.log('unknown')}}" )"

          # Chromium version: try electron-to-chromium, then fallback to Electron binary
          CHROMIUM_VER="$(node -e "
            try {
              const { electronToChromium } = require('electron-to-chromium');
              const v = '${ELECTRON_SEMVER}'.trim();
              if (!v || v === 'unknown') { console.log('unknown'); process.exit(0); }
              const clean = v.replace(/^v/i,'').split('-')[0];
              const mapped = electronToChromium(clean);
              console.log(mapped ? String(mapped) : 'unknown');
            } catch { console.log('unknown'); }
          ")"

          if [ "$CHROMIUM_VER" = "unknown" ] || [ -z "$CHROMIUM_VER" ]; then
            ELECTRON_BIN="$(node -e "try{console.log(require('electron'))}catch{process.exit(1)}" 2>/dev/null || true)"
            if [ -n "$ELECTRON_BIN" ] && [ -x "$ELECTRON_BIN" ]; then
              CHROMIUM_FROM_BIN="$(ELECTRON_RUN_AS_NODE=1 "$ELECTRON_BIN" -e "console.log(process.versions.chrome||'')" 2>/dev/null || true)"
              if [ -n "$CHROMIUM_FROM_BIN" ]; then
                CHROMIUM_VER="$CHROMIUM_FROM_BIN"
              fi
            fi
          fi

          # Electron release date (de-DE, Europe/Berlin)
          ELECTRON_DATE_DE="$(node -e "
            const cp = require('child_process');
            const v = '${ELECTRON_SEMVER}'.trim().replace(/^v/i,'');
            try {
              const out = cp.execSync('npm view electron@'+v+' time --json',{stdio:['ignore','pipe','ignore']}).toString();
              const map = JSON.parse(out)||{};
              const iso = map[v];
              if (!iso) { console.log('unknown'); process.exit(0); }
              const d = new Date(iso);
              console.log(new Intl.DateTimeFormat('de-DE',
                { timeZone:'Europe/Berlin', day:'2-digit', month:'2-digit', year:'numeric' }
              ).format(d));
            } catch { console.log('unknown'); }
          ")"

          mkdir temp-badges
          cd temp-badges

          git clone --depth=1 --branch version "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}" .

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          mkdir -p .github/badges

          echo "{\"schemaVersion\":1,\"label\":\"${BRANCH_NAME}\",\"message\":\"v${VERSION}\",\"color\":\"lightblue\"}" > ".github/badges/${BRANCH_NAME}-version.json"
          echo "{\"schemaVersion\":1,\"label\":\"node\",\"message\":\"${NODE_VERSION}\",\"color\":\"lightgrey\"}" > ".github/badges/${BRANCH_NAME}-node.json"
          echo "{\"schemaVersion\":1,\"label\":\"npm\",\"message\":\"${NPM_VERSION}\",\"color\":\"lightgrey\"}" > ".github/badges/${BRANCH_NAME}-npm.json"
          echo "{\"schemaVersion\":1,\"label\":\"electron\",\"message\":\"${ELECTRON_SEMVER}\",\"color\":\"lightblue\"}" > ".github/badges/${BRANCH_NAME}-electron.json"

          # Chromium mapping + Electron release date + combined info
          echo "{\"schemaVersion\":1,\"label\":\"chromium\",\"message\":\"${CHROMIUM_VER}\",\"color\":\"informational\"}" > ".github/badges/${BRANCH_NAME}-electron-chromium.json"
          echo "{\"schemaVersion\":1,\"label\":\"released\",\"message\":\"${ELECTRON_DATE_DE}\",\"color\":\"success\"}" > ".github/badges/${BRANCH_NAME}-electron-date.json"
          echo "{\"schemaVersion\":1,\"label\":\"Electron\",\"message\":\"${ELECTRON_SEMVER} • Chromium ${CHROMIUM_VER} • ${ELECTRON_DATE_DE}\",\"color\":\"blue\"}" > ".github/badges/${BRANCH_NAME}-electron-info.json"

          git add .github/badges/${BRANCH_NAME}-version.json
          git add .github/badges/${BRANCH_NAME}-node.json
          git add .github/badges/${BRANCH_NAME}-npm.json
          git add .github/badges/${BRANCH_NAME}-electron.json
          git add .github/badges/${BRANCH_NAME}-electron-chromium.json
          git add .github/badges/${BRANCH_NAME}-electron-date.json
          git add .github/badges/${BRANCH_NAME}-electron-info.json

          git commit -m "chore(badges): ${BRANCH_NAME} -> v${VERSION}, node ${NODE_VERSION}, npm ${NPM_VERSION}, electron ${ELECTRON_SEMVER} (chromium ${CHROMIUM_VER}, ${ELECTRON_DATE_DE})" || echo "No changes"
          git push
          cd ..
          rm -rf temp-badges

  cleanup:
    name: 'Garbage Collection'
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 7
          keep_minimum_runs: 1
